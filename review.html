<script>
  const reviewContainer = document.getElementById("reviewContainer");
  let sentenceMap = {};

  function renderReview() {
    const vocabWrong = JSON.parse(localStorage.getItem("wrong_vocab")) || [];
    const dialogueWrong = JSON.parse(localStorage.getItem("wrong_dialogue")) || [];
    const sentenceWrong = JSON.parse(localStorage.getItem("wrong_sentence")) || []; 

    const vocabWrongWithSource = vocabWrong.map(item => ({...item, source: "Vocabulary"}));
    const dialogueWrongWithSource = dialogueWrong.map(item => ({...item, source: "Dialogue"}));
    const sentenceWrongWithSource = sentenceWrong.map(item => ({...item, source: "Sentence"}));

    let allWrongAnswers = [...vocabWrongWithSource, ...dialogueWrongWithSource,...sentenceWrongWithSource];

    reviewContainer.innerHTML = '';

    if (allWrongAnswers.length === 0) {
        reviewContainer.innerHTML = '<p class="empty">目前沒有錯誤紀錄。</p>';
        return;
    }

    allWrongAnswers.forEach((item, index) => {
        const div = document.createElement("div");
        div.classList.add("review-item");

        let userAnswerFull = item.selected;
        let correctAnswerFull = item.correct;
        if (item.source === "Sentence") {
          userAnswerFull = sentenceMap[item.selected] || item.selected || '未作答';
          correctAnswerFull = sentenceMap[item.correct] || item.correct;
        }

        div.innerHTML = `
          <div class="source-label">${item.source}</div>
          <p><strong>Q${index + 1}:</strong> ${item.question}</p>
          <p>Your answer: <span class="incorrect">${userAnswerFull}</span></p>
          <p>Correct answer: <span class="correct">${correctAnswerFull}</span></p>
          <button class="delete-btn" data-index="${index}">學會了，刪除</button>
        `;

        reviewContainer.appendChild(div);
    });

    // delete logic
    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const idx = Number(btn.getAttribute("data-index"));
            const item = allWrongAnswers[idx];
            allWrongAnswers.splice(idx, 1);

            const keyMap = {
              "Vocabulary": "wrong_vocab",
              "Dialogue": "wrong_dialogue",
              "Sentence": "wrong_sentence"
            };

            const storageKey = keyMap[item.source];
            const updated = JSON.parse(localStorage.getItem(storageKey)) || [];
            const filtered = updated.filter(q => q.question !== item.question || q.selected !== item.selected);
            localStorage.setItem(storageKey, JSON.stringify(filtered));
            renderReview();
        });
    });
  }

  // 優雅處理 sentence.json 載入失敗的情況
  fetch("questions/sentence.json")
    .then(response => response.json())
    .then(data => {
      data.leftSentences.forEach(item => {
        sentenceMap[item.id] = item.text;
      });
    })
    .catch(err => {
      console.warn("無法載入 sentence.json，句子題內容將以代號呈現", err);
    })
    .finally(() => {
      renderReview();
    });
</script>
